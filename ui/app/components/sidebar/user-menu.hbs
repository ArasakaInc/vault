{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
~}}

<Hds::Dropdown class="hds-side-nav__dropdown" @listPosition="bottom-left" as |dd|>
  <dd.ToggleIcon @icon="user" @text="User menu" data-test-user-menu-trigger />
  <dd.Title data-test-user-menu-title @text={{capitalize this.auth.authData.displayName}} />
  {{#if this.auth.allowExpiration}}
    <dd.Generic>
      <Hds::Alert @type="compact" @color="warning" data-test-user-menu-item="token alert" as |A|>
        <A.Description>
          We've stopped auto-renewing your token due to inactivity. It will expire on
          {{date-format this.auth.tokenExpirationDate "MMMM do yyyy, h:mm:ss a"}}.
        </A.Description>
      </Hds::Alert>
    </dd.Generic>
  {{/if}}

  <dd.Separator />

  {{#if this.hasEntityId}}
    <dd.Interactive @text="Multi-factor authentication" @route="vault.cluster.mfa-setup" data-test-user-menu-item="mfa" />
  {{/if}}
  {{#if this.isUserpass}}
    <dd.Interactive
      @text="Reset password"
      @route="vault.cluster.access.reset-password"
      data-test-user-menu-item="reset-password"
    />
  {{/if}}
  <dd.CopyItem @text={{this.auth.currentToken}} @copyItemTitle="Copy token" class="mask-copy-snippet" />
  {{#if (is-before (now interval=1000) this.auth.tokenExpirationDate)}}
    {{#if this.auth.authData.renewable}}
      <dd.Interactive
        @text="Renew token"
        @isLoading={{this.isRenewing}}
        {{on "click" this.renewToken}}
        data-test-user-menu-item="renew token"
      />
    {{/if}}
    <dd.Interactive
      @text="Revoke token"
      @color="critical"
      {{on "click" (fn (mut this.showRevokeTokenModal) true)}}
      data-test-user-menu-item="revoke token"
    />
  {{/if}}
  <dd.Interactive
    @text="Log out"
    @route="vault.cluster.logout"
    @model={{this.currentCluster.cluster.name}}
    data-test-user-menu-item="logout"
  />
</Hds::Dropdown>

{{#if this.showRevokeTokenModal}}
  <Hds::Modal @color="critical" @size="small" @onClose={{fn (mut this.showRevokeTokenModal) false}} as |M|>
    <M.Header @icon="alert-circle">
      Revoke
      {{get this.auth "authData.displayName"}}?
    </M.Header>
    <M.Body>
      You will not be able to log in again with this token.
    </M.Body>
    <M.Footer as |F|>
      <Hds::ButtonSet>
        <Hds::Button @text="Revoke token" @color="critical" {{on "click" this.revokeToken}} data-test-confirm-button />
        <Hds::Button @color="secondary" @text="Cancel" {{on "click" F.close}} data-test-cancel-button />
      </Hds::ButtonSet>
    </M.Footer>
  </Hds::Modal>
{{/if}}